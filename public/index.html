<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Hero Pong Live</title>
    <style>
        :root { --accent: #4CAF50; }
        body { 
            margin: 0; background: #111; color: #eee; 
            font-family: 'Courier New', Courier, monospace;
            display: flex; flex-direction: column; align-items: center; 
            justify-content: center; height: 100vh; 
            overflow: hidden; touch-action: none; /* Crucial for mobile */
        }
        
        #game-container { 
            position: relative; width: 95vw; max-width: 800px;
            aspect-ratio: 2 / 1; border: 2px solid #333;
        }
        
        canvas { width: 100%; height: 100%; background: #222; display: block; }

        /* Loading Overlay */
        #loading-overlay {
            position: absolute; inset: 0; background: #111;
            display: flex; flex-direction: column; align-items: center;
            justify-content: center; z-index: 100; transition: opacity 0.5s;
        }
        .spinner {
            width: 40px; height: 40px; border: 4px solid #333;
            border-top: 4px solid var(--accent); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 15px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Scoreboard */
        .scoreboard {
            position: absolute; top: 15%; width: 100%;
            display: flex; justify-content: center;
            font-size: clamp(30px, 8vw, 60px); font-weight: bold;
            color: rgba(255, 255, 255, 0.15); pointer-events: none;
        }
        .score-divider { margin: 0 20px; }

        #ui-layer {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: space-between; padding: 10px;
        }
        .status { 
            background: rgba(0, 0, 0, 0.8); padding: 4px 10px; 
            border-radius: 4px; font-size: 10px; text-transform: uppercase;
        }
        .interactive { pointer-events: auto; }
        .btn {
            background: #fff; border: none; padding: 12px 24px; 
            font-weight: bold; cursor: pointer; border-radius: 4px; font-family: inherit;
        }
        #challenge-area { position: absolute; bottom: 10%; width: 100%; text-align: center; display: none; }
        /* Landscape Orientation Overlay */
        #orientation-overlay {
            position: fixed;
            inset: 0;
            background: #111;
            z-index: 200;
            display: none; /* Hidden by default */
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
        }

        /* Show only when screen is vertical */
        @media (orientation: portrait) {
            #orientation-overlay {
                display: flex;
            }
        }

        .phone-icon {
            width: 50px;
            height: 80px;
            border: 3px solid #eee;
            border-radius: 6px;
            margin-bottom: 20px;
            animation: rotate 2s ease-in-out infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            50% { transform: rotate(90deg); }
            100% { transform: rotate(0deg); }
        }
    </style>
</head>
<body>
    <div id="orientation-overlay">
        <div class="phone-icon"></div>
        <p>Please rotate your device to landscape mode for the best experience.</p>
    </div>
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div id="loading-text">Waking up server...</div>
    </div>

    <div id="game-container">
        <div class="scoreboard">
            <span id="score-p1">0</span>
            <span class="score-divider">:</span>
            <span id="score-p2">0</span>
        </div>

        <canvas id="pongCanvas" width="800" height="400"></canvas>
        
        <div id="ui-layer">
            <div style="text-align: center;"><span id="status-text" class="status">Connecting...</span></div>
            <div id="challenge-area" class="interactive">
                <button class="btn" onclick="sendChallenge()">CHALLENGE PLAYER</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        const canvas = document.getElementById('pongCanvas');
        const ctx = canvas.getContext('2d');
        const loadingOverlay = document.getElementById('loading-overlay');
        const statusText = document.getElementById('status-text');
        const challengeArea = document.getElementById('challenge-area');

        // State
        let myRole = null; let isPVP = false;
        let ball = { x: 400, y: 200, dx: 4, dy: 4 };
        let playerY = 160; let opponentY = 160;
        let scoreP1 = 0; let scoreP2 = 0;

        // --- Input Handling (Mouse + Touch) ---
        function handleInput(y) {
            const rect = canvas.getBoundingClientRect();
            const scaleY = canvas.height / rect.height;
            const targetY = (y - rect.top) * scaleY;
            
            // Limit movement to paddle center
            if (myRole === 'HOST' || myRole === 'CHALLENGER') {
                if (myRole === 'HOST') playerY = targetY - 40;
                else socket.emit('p2_move', targetY - 40);
            }
        }

        canvas.addEventListener('mousemove', (e) => handleInput(e.clientY));
        
        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Stop scrolling
            handleInput(e.touches[0].clientY);
        }, { passive: false });

        // --- Connection & Events ---
        socket.on('connect', () => {
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.style.display = 'none', 500);
        });

        socket.on('role', (role) => {
            myRole = role;
            statusText.innerText = role === 'HOST' ? 'You are Host' : 'Spectating';
            if (role === 'SPECTATOR') challengeArea.style.display = 'block';
        });

        socket.on('spectator_update', (state) => {
            if (myRole !== 'HOST') {
                ball = state.ball;
                playerY = state.playerY;
                opponentY = state.opponentY;
                document.getElementById('score-p1').innerText = state.scoreP1;
                document.getElementById('score-p2').innerText = state.scoreP2;
            }
        });

        socket.on('game_mode_change', (data) => {
            isPVP = true;
            if (data.challengerId === socket.id) myRole = 'CHALLENGER';
            challengeArea.style.display = 'none';
            statusText.innerText = isPVP ? 'PVP MATCH' : statusText.innerText;
        });

        // --- Game Logic (Host Only) ---
        function update() {
            if (myRole !== 'HOST') return;

            if (!isPVP) { // AI
                opponentY += (ball.y - 40 - opponentY) * 0.1;
            }

            ball.x += ball.dx; ball.y += ball.dy;
            if (ball.y < 0 || ball.y > 400) ball.dy *= -1;

            // Collisions
            if (ball.x < 12 && ball.y > playerY && ball.y < playerY + 80) ball.dx = Math.abs(ball.dx) * 1.05;
            if (ball.x > 788 && ball.y > opponentY && ball.y < opponentY + 80) ball.dx = -Math.abs(ball.dx) * 1.05;

            // Scoring
            if (ball.x < 0) { scoreP2++; resetBall(); }
            if (ball.x > 800) { scoreP1++; resetBall(); }

            socket.emit('host_update', { ball, playerY, opponentY, scoreP1, scoreP2 });
        }

        function resetBall() {
            ball = { x: 400, y: 200, dx: 4 * (Math.random() > 0.5 ? 1 : -1), dy: 4 };
            document.getElementById('score-p1').innerText = scoreP1;
            document.getElementById('score-p2').innerText = scoreP2;
        }

        function draw() {
            ctx.clearRect(0, 0, 800, 400);
            ctx.fillStyle = '#fff';
            // Left Paddle
            ctx.fillRect(0, playerY, 12, 80);
            // Right Paddle
            ctx.fillRect(788, opponentY, 12, 80);
            // Center Line
            ctx.setLineDash([5, 15]);
            ctx.beginPath(); ctx.moveTo(400,0); ctx.lineTo(400,400); ctx.strokeStyle = '#333'; ctx.stroke();
            // Ball
            ctx.beginPath(); ctx.arc(ball.x, ball.y, 8, 0, Math.PI*2); ctx.fill();
            requestAnimationFrame(() => { update(); draw(); });
        }

        function sendChallenge() { socket.emit('challenge_request'); }

        draw();
    </script>
</body>
</html>